<!DOCTYPE html>
<html dir="ltr" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>@ViewBag.Title</title>

    <!-- ==== Favicon ==== -->
    <link rel="icon" type="image/png" href="/images/fav128.ico" sizes="128x128">
    <link rel="icon" type="image/png" href="/images/fav64.ico" sizes="64x64">
    <link rel="icon" type="image/png" href="/images/fav32.ico" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/fav16.ico" sizes="16x16">

    <!-- ==== Google Font ==== -->
    <!--<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700%7CMontserrat:400,500">-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600&display=swap&subset=cyrillic" rel="stylesheet">
    <!-- ==== Stylesheets ==== -->
    <link rel="stylesheet" href="~/css/widget.chat.css">
    <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/lib/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="/css/main.min.css?v=1.0.3">
    <link rel="stylesheet" href="/css/StyleSheet.css" />
    <link rel="stylesheet" href="~/css/font-awesome.css" />
    <link rel="stylesheet" href="~/css/font-awesome.min.css" />
    <link rel="stylesheet" href="~/css/HomePageStyle.css" />
    <link rel="stylesheet" href="~/css/Bell.css" />
    <link rel="stylesheet" href="/css/print.min.css" />
    <link rel="stylesheet" href="~/css/PulseAnimation.css" />
    <link rel="stylesheet" href="~/css/loader.css" />
    <link rel="stylesheet" media="screen,projection" href="~/css/ui.totop.css" />

    <Link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>

    <script src="/lib/jquery/dist/jquery-3.3.1.min.js"></script>
</head>
<body>
    <!-- SideBar -->

    <nav id="menuVertical">
        <ul style="text-align: justify; white-space: nowrap;">
            <li>
                <a href="/ApplicationsBasePage/0"><div class="img_n"><img src="/images/icons/1.png"></div><span>База заявок</span></a>
            </li>

            <li>
                <a href="/ApplicationsBaseArchive/0"><div class="img_n"><img src="/images/icons/2.png"></div><span>Архив заявок</span></a>

            </li>

            <li>
                <a href="/OperLogPage"><div class="img_n"><img src="/images/icons/3.png"></div><span>Оперативный журнал</span></a>
            </li>

            <li><a href="/DocPage"><div class="img_n"><img src="/images/icons/5.png"></div><span>Документы</span></a></li>

            <li><a href="/DutySchedulePage"><div class="img_n"><img src="/images/icons/4.png"></div><span>График дежурств</span></a></li>

            <li><a href=""><div class="img_n"><img src=""></div><s>Рапорт</s></a></li>
            
        </ul>
    </nav>




    <style>

        .div-table {
            padding-left: 55px;
        }

        body {
            background: #f1f5f9;
            font-family: "Roboto", sans-serif, Helvetica, Arial;
            margin: 0;
        }

        .ico img {
            height: 66px;
            margin-top: 7px;
            padding: 0 0 3 16px;
        }

        #menuVertical {
            width: 71px;
            height: auto;
            position: fixed;
            z-index: 5;
            top: 100px;
            transition: .3s;
        }

            #menuVertical ul {
                display: block;
                width: 54px;
                height: auto;
                margin: 0;
                padding: 0;
                list-style: none;
                position: relative;
            }

                #menuVertical ul li {
                    display: block;
                    width: 200px;
                    position: relative;
                }

                    #menuVertical ul li a {
                        position: relative;
                        display: block;
                        width: 200px;
                        height: auto;
                        box-sizing: border-box;
                        font-size: 16px;
                        font-weight: bold;
                        color: #334155;
                        line-height: 2em;
                        padding: 15px 15px;
                        background: #f1f5f9;
                    }



                        #menuVertical ul li a:hover,
                        #menuVertical ul li:hover a {
                            background: #334155;
                            color: #fff;
                        }

                    #menuVertical ul li ul {
                        position: absolute;
                        top: 0px;
                        left: 198px;
                        display: none;
                        width: auto;
                    }

                    #menuVertical ul li:hover ul {
                        display: block;
                    }

                    #menuVertical ul li ul li a {
                        white-space: nowrap;
                        text-transform: none;
                        padding: 10px 20px;
                        width: 153px;
                    }

                        #menuVertical ul li ul li a:hover {
                            background: #334155;
                            color: #fff;
                        }

        .menu {
            position: relative;
            width: 178px;
            height: 100%;
            background: #334155;
            box-shadow: 1px 2px 3px #888;
            position: fixed;
            top: 79px;
            z-index: 3;
        }

        .footer {
            position: absolute;
            width: 178px;
            height: 288px;
            bottom: -25px;
            background: #334155;
            margin-bottom: 78px;
            z-index: 13;
            border-top: 1px solid #334155;
            color: #334155;
            text-align: center;
            padding-top: 22px;
        }

        .img_n {
            transition: .3s;
        }

            .img_n:hover {
                margin-left: 5px;
                transition: .3s;
            }

        /*MEDIA*/

        @@media screen and (max-width: 1600px) {
            .menu {
                width: 70px;
                transition: .3s;
            }

            #menuVertical ul li a {
                width: 70px;
                transition: .3s;
            }

            #menuVertical ul li {
                width: 70px;
            }

                #menuVertical ul li ul li a {
                    left: -141px;
                }

            span {
                display: none;
            }


            .img_n img {
                height: 35px;
                width: 60px;
                margin-left: -7px;
                margin-top: 0;
            }
        }

        @@media screen and (min-width: 1600px) {
            .img_n img {
                display: none;
            }
        }
    </style>


    <!-- Анимация загрузки -->
    <div class="preloader">
        <div class="preloader__row">
            <div class="preloader__item_one"></div>
            <div class="preloader__item_two"></div>
        </div>
    </div>

    <div class="wrapper">
        <header class="navbar navbar-fixed">
            <div class="d-none d-sm-block">
                <div class="navbar--header">
                    <a href="/" class="logo zoom ">
                        <img src="/images/logo-kurs-dispatcher1.png" alt="ГИП-электро АКТ">
                    </a>
                </div>
            </div>
            <div class="d-block d-sm-none">
                <div class="navbar--header">
                    <a href="/" class="logo logo-sm zoom ">
                        <img src="/images/signinLogoXS.png" alt="ГИП-электро АКТ">
                    </a>
                </div>
            </div>
            <div class="d-block d-sm-none ml-auto">
            </div>
            <div class="d-none d-sm-block d-md-none ml-auto">
            </div>
            @if (User.IsInRole("pnr") || User.IsInRole("administrator"))
            {
        <div class="navbar--nav ml-5">
            <ul class="nav">
                <li class="nav-item" id="reportForImportCount--container">
                    <a href="/ReportImport/Reports" class="nav-link" title="Импорт электронных отчётов">
                        <i class="fa fa-file-import navbar--icon"></i>
                        <div class="badge-sidebar--container">
                            <span class="badge badge-pill badge-navbar text-white bg-orange" id="reportForImportCount"></span>
                        </div>
                    </a>
                </li>
            </ul>
        </div>}

            <!-- Время и Дата -->
            <div class="clockpage navbar ml-auto" style="box-shadow: none; color: #080808">
                <div align="center" style="width: 100%; height: 100%; overflow: hidden">
                    <div style="white-space: nowrap">
                        <div style="display: inline-block" align="center">ДАТА: @DateTime.Now.ToString("dd/MM/yyyy") ВРЕМЯ:      </div>
                        <div style="display: inline-block">   </div>
                        <div style="display: inline-block" align="center"> <span id="clock"></span></div>
                    </div>
                </div>
            </div>


            <!-- Бегущая строка -->
            <div class="navbar ml-auto" id='marqueeId' style="box-shadow: none;">
                @*<marquee id="marqueeId" direction="left" scrollamount="5" style="width: 75vh; color: #ff0000; text-transform: uppercase; font-weight:bold;"></marquee>navbar*@

            </div>
            <script>
                fetch('/Notification/GetMarquee').then(r => r.json()).then(data => {
                    document.getElementById('marqueeId').innerHTML = data;
                });
            </script>

            <!-- Диспетчер на смене -->
            <div id="id_Dispatcher" class="clockpage">
              
            </div>

            <!-- Поиск -->
            <div class="navbar--search ml-auto mr-5">
                <form action="/Search">
                    <input type="search" id="search" name="query" class="form-control" placeholder="Поиск" required="">
                    <button class="btn btn-link"><i class="fa fa-search"></i></button>
                </form>
            </div>


            <!-- Выподающий меню -->
            <div class="navbar--nav">
                <ul class="nav">
                    @if (User.Identity.IsAuthenticated)
                    {
        <li class="nav-item dropdown nav--user">
            <a href="#" class="nav-link" data-toggle="dropdown">
                <img id="imageUser" src="/images/avatarilon.jpg" class="rounded-circle border border-warning" style="width: 50px; height: 50px;">
                <span id="notifCountId" class="badge badge-pill badge-navbar text-white bg-red pulse" style="top: 40px !important; left: 50px !important;" ata-toggle="tooltip" data-placement="bottom" title="Кол-во непрочитанных уведомлений"></span>
                <span>@User.Identity.Name</span>
                <i class="fa fa-angle-down"></i>
            </a>
            <ul class="dropdown-menu">
                <li><a href="/Profile"><i class="fa fa-user"></i>Профиль</a></li>
                <li><a href="/UnreadComments" class="d-flex"><i class="fa fa-comment align-self-center"></i>Комментарии <span class="badge badge-secondary ml-2 align-self-center unread-indicator">0</span></a></li>
                <li><a href="/AlertPage" class="d-flex" id="notifId"></a></li>
                @if (User.IsInRole("administrator"))
                {
        <li><a href="/HistoryPage"><i class="fa fa-history" aria-hidden="true"></i> Веб-архив</a></li>}
                <li><a href="/Files/Руководство по эксплуатации программного обеспечения.pdf" class="d-flex" target="_blank"><i class="fa fa-question align-self-center"></i>Помощь<span class="badge badge-secondary ml-2 align-self-center unread-indicator">0</span></a></li>
                @if (User.IsInRole("dispatcher"))
                {
        <li class="dropdown-divider"></li>
                            <li><a href="javascript:$('#ChangeDeliveryModal').modal('toggle')"><i class="fa fa-sign-out"></i> Сдать смену</a></li>
 }
                                            else
                                            {
                            <li class="dropdown-divider"></li>
                                                <li><a href="/Account/Logout"><i class="fa fa-power-off"></i>Выйти</a></li>}
            </ul>
        </li>
 }
                    else
                    {
        <li class="nav-item dropdown nav--user"><a href="/Account/Login" class="nav-link"><span>Войти</span></a></li>
}
                </ul>
            </div>

        </header>


        <script src="~/js/Calendar.js"></script>
        <script src="~/js/Notification.js"></script>
        <script src="~/js/jquery-1.9.1.min.js"></script>
        <script src="~/js/print.min.js"></script>

        <!-- Кнопка вверх -->
        <script src="~/js/jquery-1.7.2.min.js"></script>
        <script src="~/js/easing.js"></script>
        <script src="~/js/jquery.ui.totop.js"></script>

        <main class="main-table">
            <div class="div-table">
                @RenderBody()
                <footer class="main--footer">
                    <p>&copy; @DateTime.Now.Year - Отдел разработки ООО "КУРС"</p>
                </footer>
            </div>
        </main>
        <script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
        <script type="text/jаvascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>


    </div>


</body>
</html>


@if (User.IsInRole("dispatcher"))
{
<!-- Приемка смены -->
<div class="modal fade" id="AcceptModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div style="width: 1600px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="idRefusal">Приемка смены </h5>
                </div>
                <div class="modal-body">
                    <button class="btn btn-primary" style="width:100%" onclick="Accept()">Принять смену</button>
                </div>
            </div>
        </div>
    </div>
</div> 

<!-- Сдача смены -->
<div class="modal fade" id="ChangeDeliveryModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div style="width: 1600px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="idRefusal"><i class="fa fa-share" aria-hidden="true"></i> Сдача смены </h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <div class="modal-footer">
                        <button class="btn btn-primary" style="width:100%" onclick="PassShift()">Сдать смену</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    // *** Кнопка вверх ***
    $(document).ready(function () {
        /*
        var defaults = {
        containerID: 'toTop', // fading element id
        containerHoverID: 'toTopHover', // fading element hover id
        scrollSpeed: 1200,
        easingType: 'linear'
        };
        */

        $().UItoTop({ easingType: 'easeOutQuart' });

    });

    // *** Принятие смены ***
    function Accept() {
        comment = "";
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success m-3',
                cancelButton: 'btn btn-danger m-3'
            },
            buttonsStyling: false
        })
        swalWithBootstrapButtons.fire({
            title: 'Вы уверены?',
            text: "Вы не сможете отменить это!",
            icon: 'warning',
            confirmButtonText: 'Да!',
            cancelButtonText: 'Нет!',
            reverseButtons: true,
            showCancelButton: true
        }).then((result) => {
            if (result.dismiss === Swal.DismissReason.confirm) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", '/Shift/TakeShift', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.send();
                $('#AcceptModal').modal('toggle');
                $("#shiftId").load(location.href + " #shiftId");
                $("#shiftdiv").load(location.href + " #shiftdiv");
            }
            else {
                location.href = "/Account/Logout";
            }
        })
    }

    // *** Сдача смены ***
    function PassShift() {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success m-3',
                cancelButton: 'btn btn-danger m-3'
            },
            buttonsStyling: false
        })
        swalWithBootstrapButtons.fire({
            title: 'Вы уверены?',
            text: "Вы не сможете отменить это!",
            icon: 'warning',
            confirmButtonText: 'Да!',
            cancelButtonText: 'Нет!',
            reverseButtons: true,
            showCancelButton: true
        }).then((result) => {
            if (result.dismiss === Swal.DismissReason.confirm) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", '/Shift/PassShift', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.send();
                $('#ChangeDeliveryModal').modal('toggle');
                $("#shiftId").load(location.href + " #shiftId");
                //ok('Смена сдана');
                $("#shiftdiv").load(location.href + " #shiftdiv");
                ///Account/Logout
                location.href = "/Account/Logout";
            }

        })

    }

</script>
}

<script>

    // *** Удалить бегущую строку ***
    function DelMarque(id) {
        areyousure("id=" + encodeURIComponent(id), "/Notification/DelMarquee", "Вы уверены?", "", "");
    
    }

    // *** Получить Аватарку ***
    fetch('/Users/GetUserImage').then(r => r.json()).then(data => {
        document.getElementById('imageUser').src = data;
    });

    // *** Проверка наличия уведомления ***
    function GetCountNotif() {
        var request = new XMLHttpRequest();
        request.responseType = "json";
        request.open("GET", "/Notification/GetCountNotif");
        request.onload = function () {
            if (this.response != 0) {
                document.getElementById('notifId').innerHTML = '<i class="bell fa fa-bell align-self-center"></i> Уведомление <span id="notifTwoId" class="badge badge-secondary ml-2 align-self-center" ></span>';
                document.getElementById('notifCountId').innerHTML = this.response;
                document.getElementById('notifTwoId').innerHTML = this.response;
                document.getElementById('bellNotifId').innerHTML = '<a href="/AlertPage"><i class="bell fa fa-bell align-self-center"></i></a>';
            }
            else {
                document.getElementById('notifCountId').className = "unread-indicator";
                document.getElementById('notifId').innerHTML = ' <i class="fa fa-bell align-self-center" aria-hidden="true"></i> Уведомление';
            }
        }
        request.send();
        setTimeout("GetCountNotif()", 5000);
    }

    GetCountNotif();

    $(document).ready(function () {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                if (xmlHttp.responseText === "0") {
                    $('#reportForImportCount--container').hide();
                }
                $('#reportForImportCount').html(xmlHttp.responseText);
            }
        }
        xmlHttp.open("GET", "/ReportImport/GetReportCount", true);
        xmlHttp.send(null);
    })

</script>

@* Sweet Alerts 2 ok err*@
<script>

    // *** Успешно ***
    function ok(text) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'center',
            showConfirmButton: false,
            timer: 3000
        });

        Toast.fire({
            type: 'success',
            title: text
        })
    }

    // *** Ошибка ***
    function err(text) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'center',
            showConfirmButton: false,
            timer: 3000
        });

        Toast.fire({
            type: 'error',
            title: text
        })
    }

    // *** Информирование ***
    function info(text) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'center',
            showConfirmButton: false,
            timer: 3000
        });

        Toast.fire({
            type: 'info',
            title: text
        })
    }

    // *** Подтверждение действий ***
    function areyousure(body, url, title, text, modal) {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-primary m-3',
                cancelButton: 'btn btn-danger m-3'
            },
            buttonsStyling: false
        })

        swalWithBootstrapButtons.fire({
            title: title,
            icon: 'warning',
            text: text,
            confirmButtonText: 'Да!',
            cancelButtonText: 'Нет!',
            showCancelButton: true,
            reverseButtons: true
        }).then((result) => {
            if (result.dismiss === Swal.DismissReason.confirm) {
                var request = new XMLHttpRequest();
                request.responseType = "json";
                if (body != "") {
                    request.open("GET", url + "?" + body);
                }
                else {
                    request.open("GET", url);
                }
                request.onload = function () {
                    if (this.response == 'ok') {
                        ok('Успешно!');
                        if (modal != '') {
                            $('#' + modal).modal('toggle');
                        }
                    }
                    else {
                        err(this.response);
                    }
                }
                request.send(body);
            }
        })
    }

    //let countNotif = 0;
    //
    //fetch('/Notification/GetCountNotif').then(r => r.json()).then(data => {
    //    countNotif = data;
    //});
    //
    //// *** Push-уведомления ***
    //function PushNotif() {
    //    fetch('/Notification/GetCountNotif').then(r => r.json()).then(data => {
    //        if (countNotif < data) {
    //            countNotif = data - countNotif;
    //            info(countNotif);
    //        }
    //    });
    //    setTimeout(PushNotif, 3000);
    //}
    //
    //PushNotif();

    function notification(text) {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-primary',
                //cancelButton: 'btn btn-primary'
            },
            buttonsStyling: false
        })

        swalWithBootstrapButtons.fire({
            title: 'Уведомление',
            text: text,
            icon: 'info',
            confirmButtonText: 'OK',
        }).then((result) => {
            DeleteNotification();
        })
    }

    // Getting uread comments count
    $(document).ready(function () {
        //Hiding all indicator on document ready
        $('.unread-indicator').hide();
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                if (xmlHttp.responseText === "0") {
                    $('.unread-indicator').hide();
                }
                else {
                    $('.unread-indicator').html(xmlHttp.responseText);
                    $('.unread-indicator').show();
                }

            }
        }
        xmlHttp.open("GET", "/Comments/GetUnreadCommentsCount?name=@User.Identity.Name", true);
        xmlHttp.send(null);
    })

    // Tooltip for unread comments indicator
    $(function () {
        $('.unread-indicator').tooltip()
    })

</script>
<script src="/js/main.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Уведомления -->
<script>

    function GetDisp() {
        fetch('/Users/GetDisp').then(r => r.json()).then(data => {
            alert("ok");
            let html = "";
            html += "<h3 style='margin-left: 20px;'>" + data + "</h3>"
            document.getElementById("id_notif").value =
            notification(data);
            $('#id_disp').html(data);
        });
    }

    GetDisp();

    function CreateNotification(id, typeId) {
        var xhr = new XMLHttpRequest();
        var body = "id=" = encodeURIComponent(id) + "&typeId=" + encodeURIComponent(typeId);
        xhr.open("POST", '/Notification/CreateNotification', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send(body);
    }

    function DeleteNotification() {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/Notification/DeleteNotification', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send();
    }

    //Notification();
</script>

<!-- Часы -->
<script>
    function clockTimer() {
        var date = new Date();
        var time = [date.getHours(), date.getMinutes(), date.getSeconds()];

        if (time[0] < 10) { time[0] = "0" + time[0]; }
        if (time[1] < 10) { time[1] = "0" + time[1]; }
        if (time[2] < 10) { time[2] = "0" + time[2]; }

        var current_time = [time[0], time[1], time[2]].join(':');

        var clock = document.getElementById("clock");

        clock.innerHTML = current_time;

        setTimeout("clockTimer()", 1000);
    }

    clockTimer();
</script>


<!-- Анимация при загрузке страниц -->
<script>
    window.onload = function () {
        document.body.classList.add('loaded_hiding');
        window.setTimeout(function () {
            document.body.classList.add('loaded');
            document.body.classList.remove('loaded_hiding');
        }, 500);
    }
</script>


<style>
    .clockpage {
        margin: auto;
        @*color: #000000;*@
        background: white;
        text-align: center;
        font-size: 22px;
        padding: 10px;
        display: inline-block;
        color: inherit;
        font-weight: inherit;
        cursor: pointer;
        font-family: sans-serif;
    }

    #dayOfWeek {
        color: #000000;
        display: block;
        font-weight: normal;
        font-size: 22px;
    }

    .del-marque {
        border: none;
        background: none;
        margin: 3px;
        display: inline-block;
        color: #080808 inherit;
        font-weight: inherit;
        cursor: pointer;
    }

        .del-marque:hover {
            color: #ff6a00;
        }

</style>